<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»å…¸æ¨ç®±å­ - å¤šå…³å¡ç‰ˆ</title>
    <style>
        :root {
            --cell-size: 40px;
            --bg-color: #2c3e50;
            --wall-color: #34495e;
            --floor-color: #ecf0f1;
            --target-color: #e74c3c;
            --box-color: #d35400;
            --box-ok-color: #27ae60;
            --player-color: #2980b9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a252f;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡å­— */
        }

        h1 { margin-top: 20px; margin-bottom: 10px; }
        
        .info-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.2s;
        }

        button:hover { background-color: #2980b9; }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: #95a5a6; }
        button.secondary:hover { background-color: #7f8c8d; }

        /* æ¸¸æˆå®¹å™¨ */
        #game-board {
            display: grid;
            background-color: var(--wall-color);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* æ ¼å­æ ·å¼ */
        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* å¢™ */
        .cell.wall {
            background-color: var(--wall-color);
            border: 1px solid rgba(0,0,0,0.2);
            background-image: linear-gradient(45deg, #3d566e 25%, transparent 25%, transparent 75%, #3d566e 75%, #3d566e),
            linear-gradient(45deg, #3d566e 25%, transparent 25%, transparent 75%, #3d566e 75%, #3d566e);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
        }

        /* åœ°æ¿ */
        .cell.floor { background-color: var(--floor-color); }

        /* ç›®æ ‡ç‚¹ */
        .cell.target::after {
            content: '';
            position: absolute;
            width: 30%;
            height: 30%;
            background-color: var(--target-color);
            border-radius: 50%;
            z-index: 1;
        }

        /* ç®±å­ */
        .cell.box::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            background-color: var(--box-color);
            border: 2px solid #a04000;
            border-radius: 4px;
            z-index: 2;
            /* ç®±å­çº¹ç† */
            background-image: linear-gradient(45deg, transparent 45%, #a04000 45%, #a04000 55%, transparent 55%),
                              linear-gradient(-45deg, transparent 45%, #a04000 45%, #a04000 55%, transparent 55%);
        }

        /* ç®±å­åœ¨ç›®æ ‡ç‚¹ä¸Š (å˜è‰²) */
        .cell.box-ok::before {
            background-color: var(--box-ok-color);
            border-color: #1e8449;
            background-image: none; /* å®Œæˆåå»æ‰å‰å·çº¹ç†ï¼Œæ˜¾å¾—æ›´å¹²å‡€ */
            box-shadow: 0 0 10px var(--box-ok-color);
        }
        
        /* ç©å®¶ */
        .cell.player {
            z-index: 5;
        }
        .cell.player::before {
            content: 'ğŸ‘·'; /* ä½¿ç”¨emojiä½œä¸ºç©å®¶ */
            font-size: 28px;
            z-index: 10;
        }

        /* æç¤ºå±‚ */
        #message-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        #message-overlay h2 { color: #2ecc71; font-size: 3rem; margin-bottom: 20px; }
        
        .tips {
            font-size: 14px;
            color: #bdc3c7;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <h1>ğŸ“¦ æ¨ç®±å­å¤§å¸ˆ</h1>

    <div class="info-panel">
        <span id="level-display">ç¬¬ 1 å…³</span>
        <span>æ­¥æ•°: <span id="step-count">0</span></span>
    </div>

    <div class="controls">
        <button class="secondary" onclick="undo()" title="Zé”®">â†©ï¸ æ’¤é”€ä¸€æ­¥</button>
        <button class="secondary" onclick="resetLevel()" title="Ré”®">ğŸ”„ é‡ç½®æœ¬å…³</button>
        <button onclick="prevLevel()">ä¸Šä¸€å…³</button>
        <button onclick="nextLevel()">ä¸‹ä¸€å…³</button>
    </div>

    <div id="game-board"></div>

    <div class="tips">
        WASD æˆ– æ–¹å‘é”®ç§»åŠ¨ | R é‡ç½® | Z æ’¤é”€
    </div>

    <div id="message-overlay">
        <h2>ğŸ‰ é€šå…³!</h2>
        <button onclick="nextLevel()" style="font-size: 24px; padding: 15px 40px;">è¿›å…¥ä¸‹ä¸€å…³</button>
    </div>

<script>
    /**
     * æ¸¸æˆé…ç½®ä¸æ•°æ®
     * ç¬¦å·è¯´æ˜ï¼š
     * # : å¢™å£
     * - : åœ°æ¿ (ç©ºæ ¼ä¹Ÿå¯ä»¥ï¼Œä½†ç”¨-çœ‹å¾—æ¸…æ¥šç‚¹)
     * . : ç›®æ ‡ç‚¹
     * $ : ç®±å­
     * * : ç®±å­åœ¨ç›®æ ‡ç‚¹ä¸Š
     * @ : ç©å®¶
     * + : ç©å®¶åœ¨ç›®æ ‡ç‚¹ä¸Š
     */
    const levels = [
        // ç¬¬1å…³ï¼šæ•™å­¦
        [
            "  ##### ",
            "###   # ",
            "#.@$  # ",
            "### . # ",
            "  ##### "
        ],
        // ç¬¬2å…³ï¼šç®€å•çš„è½¬å¼¯
        [
            "#####   ",
            "#   #   ",
            "#$  #   ",
            "#  $##  ",
            "#  . #  ",
            "##.  #  ",
            "######  "
        ],
        // ç¬¬3å…³ï¼šåŒç®±åˆ†æµ
        [
            "  ####  ",
            "###  ####",
            "#     $ #",
            "# #  #$ #",
            "# . .#@ #",
            "#########"
        ],
        // ç¬¬4å…³ï¼šç»å…¸å¸ƒå±€
        [
            "#######",
            "#     #",
            "# .$. #",
            "#. $@ #",
            "# $ . #",
            "#     #",
            "#######"
        ],
        // ç¬¬5å…³ï¼šç‹­çª„é€šé“
        [
            "#######",
            "#     #",
            "# .$$ #",
            "##$ $##",
            "# .@. #",
            "#     #",
            "#######"
        ]
    ];

    let currentLevelIndex = 0;
    let currentMap = []; // å½“å‰åœ°å›¾çš„äºŒç»´æ•°ç»„çŠ¶æ€
    let steps = 0;
    let historyStack = []; // æ’¤é”€æ ˆ
    let playerPos = {x: 0, y: 0};

    const boardEl = document.getElementById('game-board');
    const stepEl = document.getElementById('step-count');
    const levelEl = document.getElementById('level-display');
    const overlay = document.getElementById('message-overlay');

    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
        loadLevel(currentLevelIndex);
        
        // é”®ç›˜ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (overlay.style.display === 'flex' && e.key === 'Enter') {
                nextLevel();
                return;
            }

            switch(e.key) {
                case 'ArrowUp': case 'w': case 'W': move(-1, 0); break;
                case 'ArrowDown': case 's': case 'S': move(1, 0); break;
                case 'ArrowLeft': case 'a': case 'A': move(0, -1); break;
                case 'ArrowRight': case 'd': case 'D': move(0, 1); break;
                case 'z': case 'Z': undo(); break;
                case 'r': case 'R': resetLevel(); break;
            }
        });
    }

    // è§£æå¹¶åŠ è½½å…³å¡
    function loadLevel(index) {
        if (index < 0) index = 0;
        if (index >= levels.length) {
            alert("æ­å–œä½ é€šå…³äº†æ‰€æœ‰å…³å¡ï¼å›åˆ°ç¬¬ä¸€å…³ã€‚");
            index = 0;
        }

        currentLevelIndex = index;
        levelEl.innerText = `ç¬¬ ${index + 1} å…³`;
        steps = 0;
        stepEl.innerText = steps;
        historyStack = [];
        overlay.style.display = 'none';

        // æ·±åº¦å¤åˆ¶åœ°å›¾æ•°æ®ï¼Œå› ä¸ºæ¸¸æˆè¿‡ç¨‹ä¸­ä¼šä¿®æ”¹å®ƒ
        const rawMap = levels[index];
        currentMap = rawMap.map(row => row.split(''));
        
        // æ‰¾åˆ°ç©å®¶ä½ç½®
        for(let r=0; r<currentMap.length; r++) {
            for(let c=0; c<currentMap[r].length; c++) {
                if(currentMap[r][c] === '@' || currentMap[r][c] === '+') {
                    playerPos = {x: r, y: c};
                }
            }
        }

        render();
    }

    // æ¸²æŸ“åœ°å›¾
    function render() {
        boardEl.innerHTML = '';
        const rows = currentMap.length;
        const cols = currentMap[0].length; // å‡è®¾æ¯è¡Œé•¿åº¦ä¸€è‡´æˆ–å–æœ€å¤§

        // è®¾ç½® Grid å¸ƒå±€
        boardEl.style.gridTemplateRows = `repeat(${rows}, var(--cell-size))`;
        boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const char = currentMap[r][c] || ' '; // é˜²æ­¢è¶Šç•Œ
                const cell = document.createElement('div');
                cell.classList.add('cell');

                // æ ¹æ®å­—ç¬¦æ·»åŠ æ ·å¼ç±»
                if (char === '#') cell.classList.add('wall');
                else cell.classList.add('floor'); // é»˜è®¤éƒ½æ˜¯åœ°æ¿

                if (char === '.' || char === '+' || char === '*') cell.classList.add('target');
                if (char === '$') cell.classList.add('box');
                if (char === '*') { cell.classList.add('box'); cell.classList.add('box-ok'); }
                if (char === '@' || char === '+') cell.classList.add('player');

                boardEl.appendChild(cell);
            }
        }
    }

    // ç§»åŠ¨é€»è¾‘
    function move(dx, dy) {
        const x = playerPos.x;
        const y = playerPos.y;
        const nextX = x + dx;
        const nextY = y + dy;
        const nextNextX = nextX + dx;
        const nextNextY = nextY + dy;

        const nextChar = currentMap[nextX][nextY];
        
        // 1. æ’å¢™
        if (nextChar === '#') return;

        // 2. ç§»åŠ¨åŠ¨ä½œå‘ç”Ÿå‰ï¼Œè®°å½•å†å²ç”¨äºæ’¤é”€
        // ä¿å­˜å½“å‰åœ°å›¾çš„å¿«ç…§ï¼ˆæ·±æ‹·è´ï¼‰å’Œç©å®¶ä½ç½®
        const mapSnapshot = currentMap.map(row => [...row]);
        const state = {
            map: mapSnapshot,
            player: {...playerPos},
            steps: steps
        };

        let moved = false;

        // 3. å¦‚æœå‰æ–¹æ˜¯åœ°æ¿æˆ–ç›®æ ‡ç‚¹ -> ç›´æ¥ç§»åŠ¨
        if ([' ', '.', '-'].includes(nextChar)) {
            movePlayer(x, y, nextX, nextY);
            moved = true;
        }
        // 4. å¦‚æœå‰æ–¹æ˜¯ç®±å­ -> å°è¯•æ¨ç®±å­
        else if (['$', '*'].includes(nextChar)) {
            const nextNextChar = currentMap[nextNextX][nextNextY];
            // å¦‚æœç®±å­åé¢æ˜¯åœ°æ¿æˆ–ç›®æ ‡ç‚¹ -> å¯ä»¥æ¨
            if ([' ', '.', '-'].includes(nextNextChar)) {
                moveBox(nextX, nextY, nextNextX, nextNextY);
                movePlayer(x, y, nextX, nextY);
                moved = true;
            }
        }

        if (moved) {
            historyStack.push(state);
            // é™åˆ¶æ’¤é”€æ­¥æ•°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼ˆå¯é€‰ï¼‰
            if(historyStack.length > 50) historyStack.shift(); 
            
            steps++;
            stepEl.innerText = steps;
            render();
            checkWin();
        }
    }

    // ç§»åŠ¨ç©å®¶æ•°æ®æ›´æ–°
    function movePlayer(fromX, fromY, toX, toY) {
        const fromChar = currentMap[fromX][fromY];
        const toChar = currentMap[toX][toY];

        // ç¦»å¼€å½“å‰æ ¼
        if (fromChar === '@') currentMap[fromX][fromY] = ' '; // åªæ˜¯åœ°æ¿
        else if (fromChar === '+') currentMap[fromX][fromY] = '.'; // ä¹‹å‰åœ¨ç›®æ ‡ç‚¹ä¸Šï¼Œç¦»å¼€åå‰©ä¸‹ç›®æ ‡ç‚¹

        // è¿›å…¥ä¸‹ä¸€æ ¼
        if (toChar === ' ') currentMap[toX][toY] = '@';
        else if (toChar === '.') currentMap[toX][toY] = '+';
        
        playerPos = {x: toX, y: toY};
    }

    // ç§»åŠ¨ç®±å­æ•°æ®æ›´æ–°
    function moveBox(fromX, fromY, toX, toY) {
        const fromChar = currentMap[fromX][fromY];
        const toChar = currentMap[toX][toY];

        // ç®±å­ç¦»å¼€ (æ³¨æ„ï¼šç©å®¶ç´§æ¥ç€ä¼šè¿›å…¥ fromX, fromYï¼Œæ‰€ä»¥åœ¨ movePlayer é‡Œå¤„ç†è¯¥æ ¼å­çš„åç»­çŠ¶æ€ï¼Œè¿™é‡Œå…ˆæŠŠç®±å­æ‹¿èµ°)
        // å®é™…ä¸Šåœ¨ movePlayer è°ƒç”¨å‰ï¼ŒfromX, fromY è¿˜æ˜¯ç®±å­ï¼Œè¿™é‡Œåªéœ€è¦æŠŠç®±å­æ”¾åˆ° toX, toY å³å¯
        // é€»è¾‘ï¼šç®±å­ä» A åˆ° Bã€‚A å˜æˆäº†æ— ç®±å­çŠ¶æ€ï¼ˆç¨åè¢«ç©å®¶å æ®ï¼‰ï¼ŒB å˜æˆæœ‰ç®±å­çŠ¶æ€ã€‚

        // è®¾ç½®æ–°ä½ç½®çš„ç®±å­
        if (toChar === ' ') currentMap[toX][toY] = '$';
        else if (toChar === '.') currentMap[toX][toY] = '*';
    }

    // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
    function checkWin() {
        for(let r=0; r<currentMap.length; r++) {
            for(let c=0; c<currentMap[r].length; c++) {
                // å¦‚æœè¿˜æœ‰æ™®é€šç®±å­ '$' (ä¸åœ¨ç›®æ ‡ç‚¹ä¸Šçš„ç®±å­)ï¼Œåˆ™æ²¡èµ¢
                if (currentMap[r][c] === '$') return; 
            }
        }
        // èƒœåˆ©
        setTimeout(() => {
            overlay.style.display = 'flex';
        }, 100);
    }

    // æ’¤é”€åŠŸèƒ½
    function undo() {
        if (historyStack.length === 0) return;
        const prevState = historyStack.pop();
        currentMap = prevState.map;
        playerPos = prevState.player;
        steps = prevState.steps;
        stepEl.innerText = steps;
        render();
    }

    function resetLevel() {
        if(confirm("ç¡®å®šè¦é‡ç½®å½“å‰å…³å¡å—ï¼Ÿ")) {
            loadLevel(currentLevelIndex);
        }
    }

    function nextLevel() {
        loadLevel(currentLevelIndex + 1);
    }

    function prevLevel() {
        loadLevel(currentLevelIndex - 1);
    }

    // å¯åŠ¨
    initGame();

</script>
</body>
</html>