<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ‰‹åŠ¿è¯†åˆ«</title>
    <style>
        body {
            margin: 0;
            background-color: #1e1e1e;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        h1 { margin-top: 10px; font-size: 24px; color: #00ffcc; text-shadow: 0 0 10px rgba(0,255,204,0.5); }

        .container {
            position: relative;
            margin-top: 20px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 640px;
            height: 480px;
            background: #000;
        }

        /* è§†é¢‘å’Œç”»å¸ƒé‡å  */
        #input_video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            object-fit: cover;
        }

        #output_canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: scaleX(-1); /* ç”»å¸ƒä¹Ÿè¦é•œåƒï¼Œå¦åˆ™éª¨éª¼å¯¹ä¸ä¸Š */
        }

        /* è¯†åˆ«ç»“æœå±•ç¤ºé¢æ¿ */
        #result-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
            opacity: 0; /* åˆå§‹éšè— */
        }
        
        #result-panel.show { opacity: 1; }

        .emoji { font-size: 40px; }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffcc;
            font-size: 18px;
            z-index: 10;
        }
    </style>
</head>
<body>

    <h1>ğŸ–ï¸ AI å®æ—¶æ‰‹åŠ¿è¯†åˆ«</h1>

    <div class="container">
        <div id="loading">æ­£åœ¨åŠ è½½ AI æ¨¡å‹ï¼Œè¯·ç¨å€™...</div>
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
        
        <div id="result-panel">
            <span id="gesture-emoji">ğŸ¤”</span>
            <span id="gesture-name">æ£€æµ‹ä¸­...</span>
        </div>
    </div>

    <!-- å¼•å…¥ MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const resultPanel = document.getElementById('result-panel');
        const gestureNameEl = document.getElementById('gesture-name');
        const gestureEmojiEl = document.getElementById('gesture-emoji');
        const loadingEl = document.getElementById('loading');

        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvasElement.width = 640;
        canvasElement.height = 480;

        /**
         * ç®€å•çš„å‡ ä½•ç®—æ³•ï¼šåˆ¤æ–­æ‰‹æŒ‡æ˜¯ä¼¸ç›´è¿˜æ˜¯å¼¯æ›²
         * @param {Array} landmarks - 21ä¸ªå…³é”®ç‚¹
         * @returns {Array} - [æ‹‡æŒ‡, é£ŸæŒ‡, ä¸­æŒ‡, æ— åæŒ‡, å°æŒ‡] (1=ä¼¸ç›´, 0=å¼¯æ›²)
         */
        function getFingerStatus(landmarks) {
            const fingers = [];
            
            // å…³é”®ç‚¹ç´¢å¼•
            // æ‹‡æŒ‡: 4 (Tip), 3 (IP), 2 (MCP)
            // é£ŸæŒ‡: 8 (Tip), 6 (PIP)
            // ä¸­æŒ‡: 12 (Tip), 10 (PIP)
            // æ— åæŒ‡: 16 (Tip), 14 (PIP)
            // å°æŒ‡: 20 (Tip), 18 (PIP)

            // 1. æ‹‡æŒ‡åˆ¤æ–­ (æ¯”è¾ƒ X è½´è·ç¦»)
            // æ³¨æ„ï¼šå› ä¸ºæ˜¯é•œåƒï¼Œå·¦å³æ‰‹é€»è¾‘ç›¸åï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼š
            // åˆ¤æ–­æ‹‡æŒ‡æŒ‡å°–æ˜¯å¦æ¯”æŒ‡å…³èŠ‚æ›´è¿œç¦»æ‰‹æŒä¸­å¿ƒ(å°æŒ‡æ ¹éƒ¨17)
            const thumbTip = landmarks[4];
            const thumbIp = landmarks[3];
            const pinkyMcp = landmarks[17];
            
            // è®¡ç®—æ‹‡æŒ‡æŒ‡å°–åˆ°å°æŒ‡æ ¹éƒ¨çš„è·ç¦» vs æ‹‡æŒ‡å…³èŠ‚åˆ°å°æŒ‡æ ¹éƒ¨çš„è·ç¦»
            const distTip = Math.hypot(thumbTip.x - pinkyMcp.x, thumbTip.y - pinkyMcp.y);
            const distIp = Math.hypot(thumbIp.x - pinkyMcp.x, thumbIp.y - pinkyMcp.y);
            
            // å¦‚æœæŒ‡å°–è·ç¦»æ›´è¿œï¼Œè¯´æ˜ä¼¸ç›´
            fingers.push(distTip > distIp * 1.1 ? 1 : 0);

            // 2. å…¶ä»–å››æŒ‡åˆ¤æ–­ (æ¯”è¾ƒ Y è½´)
            // åœ¨å±å¹•åæ ‡ç³»ä¸­ï¼Œyè¶Šå°è¶Šé ä¸Šã€‚å¦‚æœæŒ‡å°–(Tip)çš„y < å…³èŠ‚(PIP)çš„yï¼Œè¯´æ˜æ‰‹æŒ‡æ˜¯ç«–ç›´å‘ä¸Šçš„
            const fingerIndices = [8, 12, 16, 20]; // é£ŸæŒ‡ã€ä¸­æŒ‡ã€æ— åæŒ‡ã€å°æŒ‡
            const pipIndices = [6, 10, 14, 18];   // å¯¹åº”çš„ä¸­é—´å…³èŠ‚

            for (let i = 0; i < 4; i++) {
                const tip = landmarks[fingerIndices[i]];
                const pip = landmarks[pipIndices[i]];
                // è¿˜è¦è€ƒè™‘æ‰‹æŒå€’ç½®çš„æƒ…å†µï¼Œè¿™é‡Œä½¿ç”¨æŒå¿ƒ(0)åˆ°ä¸­æŒ‡æ ¹(9)çš„å‘é‡ä½œä¸ºå‚è€ƒä¼šæ›´å‡†
                // ä½†ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·æ‰‹æŒæ˜¯æœä¸Šçš„ï¼ˆå¸¸è§„æ‰‹åŠ¿ï¼‰
                // æ”¹è¿›ï¼šè®¡ç®—ç‚¹ç§¯æˆ–ç®€å•æ¯”è¾ƒYå€¼ (Tip Y < Pip Y)
                if (tip.y < pip.y) {
                    fingers.push(1);
                } else {
                    fingers.push(0);
                }
            }
            return fingers;
        }

        /**
         * è¯†åˆ«æ‰‹åŠ¿åç§°
         */
        function recognizeGesture(fingers) {
            // fingers: [æ‹‡æŒ‡, é£ŸæŒ‡, ä¸­æŒ‡, æ— åæŒ‡, å°æŒ‡]
            const f = fingers;
            
            // 5æŒ‡å…¨å¼ å¼€ -> å¸ƒ
            if (f[0] && f[1] && f[2] && f[3] && f[4]) return { name: "å¸ƒ (Paper)", emoji: "ğŸ–ï¸" };
            
            // 5æŒ‡å…¨å¼¯æ›² -> çŸ³å¤´
            if (!f[0] && !f[1] && !f[2] && !f[3] && !f[4]) return { name: "çŸ³å¤´ (Rock)", emoji: "âœŠ" };
            
            // é£ŸæŒ‡+ä¸­æŒ‡ä¼¸ç›´ï¼Œå…¶ä»–å¼¯æ›² -> å‰ªåˆ€
            if (!f[0] && f[1] && f[2] && !f[3] && !f[4]) return { name: "å‰ªåˆ€ (Scissors)", emoji: "âœŒï¸" };
            
            // æ‹‡æŒ‡ä¼¸ç›´ï¼Œå…¶ä»–å¼¯æ›² -> ç‚¹èµ
            if (f[0] && !f[1] && !f[2] && !f[3] && !f[4]) return { name: "ç‚¹èµ (Good)", emoji: "ğŸ‘" };
            
            // æ‹‡æŒ‡+é£ŸæŒ‡+å°æŒ‡ -> çˆ±ä½ 
            if (f[0] && f[1] && !f[2] && !f[3] && f[4]) return { name: "çˆ±ä½  (Love)", emoji: "ğŸ¤Ÿ" };
            
            // é£ŸæŒ‡ä¼¸ç›´ -> 1
            if (!f[0] && f[1] && !f[2] && !f[3] && !f[4]) return { name: "ä¸€ (One)", emoji: "â˜ï¸" };
            
            // å°æŒ‡ä¼¸ç›´ -> Pinky
            if (!f[0] && !f[1] && !f[2] && !f[3] && f[4]) return { name: "çº¦å®š (Pinky)", emoji: "ğŸ¤™" };

            // æ‹‡æŒ‡+å°æŒ‡ -> 666
            if (f[0] && !f[1] && !f[2] && !f[3] && f[4]) return { name: "666 (Six)", emoji: "ğŸ¤™" };

             // é£ŸæŒ‡+å°æŒ‡ -> Rock n Roll
            if (!f[0] && f[1] && !f[2] && !f[3] && f[4]) return { name: "æ‘‡æ»š (Rock)", emoji: "ğŸ¤˜" };

            return { name: "", emoji: "" };
        }

        // --- MediaPipe å¤„ç†ç»“æœ ---
        function onResults(results) {
            loadingEl.style.display = 'none';
            resultPanel.classList.add('show');

            // 1. æ¸…ç©ºç”»å¸ƒå¹¶ç»˜åˆ¶è§†é¢‘å¸§
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // 2. å¦‚æœæ£€æµ‹åˆ°æ‰‹
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                // åªå–ç¬¬ä¸€åªæ‰‹
                const landmarks = results.multiHandLandmarks[0];

                // ç»˜åˆ¶éª¨éª¼è¿çº¿
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00ffcc', lineWidth: 5});
                drawLandmarks(canvasCtx, landmarks, {color: '#ff3366', lineWidth: 2, radius: 4});

                // è¯†åˆ«æ‰‹åŠ¿
                const fingersStatus = getFingerStatus(landmarks);
                const gesture = recognizeGesture(fingersStatus);

                if (gesture.name) {
                    gestureNameEl.innerText = gesture.name;
                    gestureEmojiEl.innerText = gesture.emoji;
                    resultPanel.style.background = "rgba(255, 255, 255, 0.95)";
                } else {
                    gestureNameEl.innerText = "æœªçŸ¥æ‰‹åŠ¿";
                    gestureEmojiEl.innerText = "ğŸ¤·";
                    resultPanel.style.background = "rgba(255, 255, 255, 0.7)";
                }
            } else {
                gestureNameEl.innerText = "æœªæ£€æµ‹åˆ°æ‰‹";
                gestureEmojiEl.innerText = "ğŸ‘€";
            }

            canvasCtx.restore();
        }

        // --- åˆå§‹åŒ– MediaPipe Hands ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1, // åªè¯†åˆ«ä¸€åªæ‰‹ï¼Œé˜²æ­¢æ‰“æ¶
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // --- å¯åŠ¨æ‘„åƒå¤´ ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();

    </script>
</body>
</html>